<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard MTC - Persona.cx</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .dashboard-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            padding: 1.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert-badge {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Componente de Login
        function LoginScreen({ onLogin }) {
            const [senha, setSenha] = useState('');
            const [erro, setErro] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                // Senha única para toda equipe (injetada pelo backend em window.__DASHBOARD_PASSWORD)
                const senhaCorreta = (window && window.__DASHBOARD_PASSWORD) || 'persona2025';
                
                if (senha === senhaCorreta) {
                    localStorage.setItem('dashboard_auth', 'true');
                    onLogin();
                } else {
                    setErro('Senha incorreta');
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="dashboard-card max-w-md w-full">
                        <h1 className="text-3xl font-bold text-center mb-6 text-gray-800">
                            🔐 Dashboard MTC
                        </h1>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Senha da Equipe
                                </label>
                                <input
                                    type="password"
                                    value={senha}
                                    onChange={(e) => setSenha(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    placeholder="Digite a senha"
                                />
                            </div>
                            {erro && (
                                <div className="bg-red-50 text-red-600 px-4 py-2 rounded-lg text-sm">
                                    {erro}
                                </div>
                            )}
                            <button
                                type="submit"
                                className="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-2 px-4 rounded-lg font-medium hover:from-purple-700 hover:to-indigo-700 transition"
                            >
                                Entrar
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // Componente principal do Dashboard
        function Dashboard() {
            const [metricas, setMetricas] = useState(null);
            const [alertas, setAlertas] = useState(null);
            const [loading, setLoading] = useState(true);
            const [filtros, setFiltros] = useState({
                periodo: '30',
                elemento: 'todos',
                quadrante: 'todos',
                prioridade: 'todos'
            });
            
            const chartRefs = {
                status: useRef(null),
                elemento: useRef(null),
                evolucao: useRef(null),
                funil: useRef(null)
            };
            
            const chartInstances = useRef({});

            // Carregar dados
            const carregarDados = async () => {
                setLoading(true);
                try {
                    const headers = {};
                    if (window && window.__DASHBOARD_API_SECRET) {
                        headers['Authorization'] = `Bearer ${window.__DASHBOARD_API_SECRET}`;
                    }
                    const [metricasRes, alertasRes] = await Promise.all([
                        fetch('/api/dashboard/metrics', { headers }),
                        fetch('/api/dashboard/alerts', { headers })
                    ]);
                    
                    const metricasData = await metricasRes.json();
                    const alertasData = await alertasRes.json();
                    
                    if (metricasData.success) {
                        setMetricas(metricasData.metricas);
                    }
                    
                    if (alertasData.success) {
                        setAlertas(alertasData.alertas);
                    }
                } catch (error) {
                    console.error('Erro ao carregar dados:', error);
                } finally {
                    setLoading(false);
                }
            };

            // Auto-refresh a cada 5 minutos
            useEffect(() => {
                carregarDados();
                const interval = setInterval(carregarDados, 5 * 60 * 1000);
                return () => clearInterval(interval);
            }, []);

            // Renderizar gráficos quando dados mudarem
            useEffect(() => {
                if (metricas) {
                    renderizarGraficos();
                }
            }, [metricas]);

            const renderizarGraficos = () => {
                // Destruir gráficos anteriores
                Object.values(chartInstances.current).forEach(chart => {
                    if (chart) chart.destroy();
                });

                // Gráfico de Status WhatsApp (Pizza)
                try {
                    if (chartRefs.status.current) {
                        const ctx = chartRefs.status.current.getContext('2d');
                        const statusData = metricas.distribuicao_status_whatsapp || {};
                        const labels = Object.keys(statusData);
                        const data = Object.values(statusData);
                        console.log('Status WhatsApp:', labels, data);
                        chartInstances.current.status = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: labels.length ? labels : ['Sem dados'],
                                datasets: [{
                                    data: data.length ? data : [1],
                                    backgroundColor: [
                                        '#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6'
                                    ]
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { position: 'bottom' }
                                }
                            }
                        });
                    }
                } catch (e) { console.error('Erro gráfico status:', e); }

                // Gráfico de Elementos MTC (Barras)
                try {
                    if (chartRefs.elemento.current) {
                        const ctx = chartRefs.elemento.current.getContext('2d');
                        const elementoData = metricas.distribuicao_elemento_mtc || {};
                        const labels = Object.keys(elementoData);
                        const data = Object.values(elementoData).map(e => e.count);
                        console.log('Elementos MTC:', labels, data);
                        chartInstances.current.elemento = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels.length ? labels : ['Sem dados'],
                                datasets: [{
                                    label: 'Quantidade',
                                    data: data.length ? data : [1],
                                    backgroundColor: '#667eea'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false }
                                },
                                scales: {
                                    y: { beginAtZero: true }
                                }
                            }
                        });
                    }
                } catch (e) { console.error('Erro gráfico elemento:', e); }

                // Gráfico de Evolução Temporal (Linha)
                try {
                    if (chartRefs.evolucao.current) {
                        const ctx = chartRefs.evolucao.current.getContext('2d');
                        const evolucaoData = Array.isArray(metricas.evolucao_temporal) ? metricas.evolucao_temporal : [];
                        const labels = evolucaoData.map(e => e.data.split('-').slice(1).join('/'));
                        const data = evolucaoData.map(e => e.leads);
                        console.log('Evolução temporal:', labels, data);
                        chartInstances.current.evolucao = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels.length ? labels : ['Sem dados'],
                                datasets: [{
                                    label: 'Leads por Dia',
                                    data: data.length ? data : [0],
                                    borderColor: '#667eea',
                                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                    fill: true,
                                    tension: 0.4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false }
                                },
                                scales: {
                                    y: { beginAtZero: true }
                                }
                            }
                        });
                    }
                } catch (e) { console.error('Erro gráfico evolução:', e); }

                // Gráfico de Funil (Barras Horizontais)
                try {
                    if (chartRefs.funil.current) {
                        const ctx = chartRefs.funil.current.getContext('2d');
                        const funilData = metricas.funil || {};
                        const data = [
                            funilData.total_quiz_completado || 0,
                            funilData.com_diagnostico || 0,
                            funilData.diagnostico_enviado || 0,
                            funilData.desafio_enviado || 0
                        ];
                        console.log('Funil:', data);
                        chartInstances.current.funil = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: ['Quiz Completo', 'Com Diagnóstico', 'WhatsApp Enviado', 'Desafio Enviado'],
                                datasets: [{
                                    label: 'Leads',
                                    data: data,
                                    backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#8b5cf6']
                                }]
                            },
                            options: {
                                indexAxis: 'y',
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false }
                                },
                                scales: {
                                    x: { beginAtZero: true }
                                }
                            }
                        });
                    }
                } catch (e) { console.error('Erro gráfico funil:', e); }
            };

            // Exportar dados
            const exportarCSV = () => {
                if (!metricas) return;
                
                const csv = [
                    ['Métrica', 'Valor'],
                    ['Total Leads', metricas.totais_leads.total],
                    ['Leads Hoje', metricas.totais_leads.hoje],
                    ['Leads Semana', metricas.totais_leads.semana],
                    ['Leads Mês', metricas.totais_leads.mes],
                    ['Lead Score Médio', metricas.lead_score.media],
                    ['Leads VIP', metricas.lead_score.vips],
                    ['Taxa Sucesso Envios', metricas.sucesso_envios.taxa_sucesso + '%']
                ].map(row => row.join(',')).join('\n');
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `dashboard-mtc-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
            };

            const handleLogout = () => {
                localStorage.removeItem('dashboard_auth');
                window.location.reload();
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="loading-spinner mx-auto mb-4"></div>
                            <p className="text-white text-lg">Carregando dados...</p>
                        </div>
                    </div>
                );
            }

            if (!metricas) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="dashboard-card text-center">
                            <p className="text-red-600">Erro ao carregar dados</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen p-4 md:p-8">
                    {/* Header */}
                    <div className="dashboard-card mb-6">
                        <div className="flex justify-between items-center">
                            <div>
                                <h1 className="text-3xl font-bold text-gray-800">📊 Dashboard MTC</h1>
                                <p className="text-gray-600 mt-1">
                                    Atualizado: {new Date(metricas.timestamp).toLocaleString('pt-BR')}
                                </p>
                            </div>
                            <div className="flex gap-3">
                                <button
                                    onClick={carregarDados}
                                    className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"
                                >
                                    🔄 Atualizar
                                </button>
                                <button
                                    onClick={exportarCSV}
                                    className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition"
                                >
                                    📥 Exportar CSV
                                </button>
                                <button
                                    onClick={handleLogout}
                                    className="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition"
                                >
                                    🚪 Sair
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Alertas */}
                    {alertas && alertas.alertas_ativos.length > 0 && (
                        <div className="dashboard-card mb-6 bg-red-50 border-l-4 border-red-500">
                            <h2 className="text-xl font-bold text-red-800 mb-3">🚨 Alertas Ativos</h2>
                            <div className="space-y-2">
                                {alertas.alertas_ativos.map((alerta, idx) => (
                                    <div key={idx} className="bg-white p-3 rounded-lg">
                                        <p className="font-semibold text-red-700">{alerta.mensagem}</p>
                                        <p className="text-sm text-gray-600">Severidade: {alerta.severidade}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Cards de Métricas Principais */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div className="dashboard-card">
                            <p className="text-gray-600 text-sm font-medium">Total de Leads</p>
                            <p className="metric-value">{metricas.totais_leads.total.toLocaleString('pt-BR')}</p>
                            <p className="text-sm text-gray-500 mt-2">
                                Hoje: {metricas.totais_leads.hoje} | Mês: {metricas.totais_leads.mes}
                            </p>
                        </div>
                        
                        <div className="dashboard-card">
                            <p className="text-gray-600 text-sm font-medium">Leads VIP</p>
                            <p className="metric-value">{metricas.lead_score.vips}</p>
                            <p className="text-sm text-gray-500 mt-2">
                                Score médio: {metricas.lead_score.media}
                            </p>
                        </div>
                        
                        <div className="dashboard-card">
                            <p className="text-gray-600 text-sm font-medium">Taxa de Sucesso</p>
                            <p className="metric-value">{metricas.sucesso_envios.taxa_sucesso}%</p>
                            <p className="text-sm text-gray-500 mt-2">
                                {metricas.sucesso_envios.sucessos} de {metricas.sucesso_envios.total_envios} envios
                            </p>
                        </div>
                        
                        <div className="dashboard-card">
                            <p className="text-gray-600 text-sm font-medium">Conversão Quiz→Diagnóstico</p>
                            <p className="metric-value">{metricas.conversoes_principais.conversao_cadastro_diagnostico}%</p>
                            <p className="text-sm text-gray-500 mt-2">
                                {metricas.conversoes_principais.finalizaram_diagnostico} completaram
                            </p>
                        </div>
                    </div>

                    {/* Conversões Principais */}
                    <div className="dashboard-card mb-6">
                        <h2 className="text-xl font-bold text-gray-800 mb-4">🎯 Conversões Principais</h2>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div className="bg-blue-50 p-4 rounded-lg">
                                <p className="text-sm text-gray-600 mb-1">Quiz → Diagnóstico</p>
                                <p className="text-2xl font-bold text-blue-600">
                                    {metricas.conversoes_principais.conversao_cadastro_diagnostico}%
                                </p>
                            </div>
                            <div className="bg-green-50 p-4 rounded-lg">
                                <p className="text-sm text-gray-600 mb-1">Diagnóstico → WhatsApp</p>
                                <p className="text-2xl font-bold text-green-600">
                                    {metricas.conversoes_principais.conversao_diagnostico_whatsapp}%
                                </p>
                            </div>
                            <div className="bg-purple-50 p-4 rounded-lg">
                                <p className="text-sm text-gray-600 mb-1">WhatsApp → Desafio</p>
                                <p className="text-2xl font-bold text-purple-600">
                                    {metricas.funil.conversao_whatsapp_desafio}%
                                </p>
                            </div>
                        </div>
                    </div>

                    {/* Gráficos */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div className="dashboard-card">
                            <h3 className="text-lg font-bold text-gray-800 mb-4">Status WhatsApp</h3>
                            <div style={{ height: '300px' }}>
                                <canvas ref={chartRefs.status}></canvas>
                            </div>
                        </div>
                        
                        <div className="dashboard-card">
                            <h3 className="text-lg font-bold text-gray-800 mb-4">Elementos MTC</h3>
                            <div style={{ height: '300px' }}>
                                <canvas ref={chartRefs.elemento}></canvas>
                            </div>
                        </div>
                        
                        <div className="dashboard-card lg:col-span-2">
                            <h3 className="text-lg font-bold text-gray-800 mb-4">Evolução Temporal (30 dias)</h3>
                            <div style={{ height: '300px' }}>
                                <canvas ref={chartRefs.evolucao}></canvas>
                            </div>
                        </div>
                        
                        <div className="dashboard-card lg:col-span-2">
                            <h3 className="text-lg font-bold text-gray-800 mb-4">Funil de Conversão</h3>
                            <div style={{ height: '250px' }}>
                                <canvas ref={chartRefs.funil}></canvas>
                            </div>
                        </div>
                    </div>

                    {/* Distribuição por Prioridade */}
                    <div className="dashboard-card">
                        <h2 className="text-xl font-bold text-gray-800 mb-4">📈 Leads por Prioridade</h2>
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div className="bg-red-50 p-4 rounded-lg text-center">
                                <p className="text-sm text-gray-600 mb-1">Alta</p>
                                <p className="text-3xl font-bold text-red-600">
                                    {metricas.distribuicao_prioridade.alta}
                                </p>
                            </div>
                            <div className="bg-yellow-50 p-4 rounded-lg text-center">
                                <p className="text-sm text-gray-600 mb-1">Média</p>
                                <p className="text-3xl font-bold text-yellow-600">
                                    {metricas.distribuicao_prioridade.media}
                                </p>
                            </div>
                            <div className="bg-green-50 p-4 rounded-lg text-center">
                                <p className="text-sm text-gray-600 mb-1">Baixa</p>
                                <p className="text-3xl font-bold text-green-600">
                                    {metricas.distribuicao_prioridade.baixa}
                                </p>
                            </div>
                            <div className="bg-gray-50 p-4 rounded-lg text-center">
                                <p className="text-sm text-gray-600 mb-1">Sem Prioridade</p>
                                <p className="text-3xl font-bold text-gray-600">
                                    {metricas.distribuicao_prioridade.sem_prioridade}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // App Principal
        function App() {
            const [autenticado, setAutenticado] = useState(false);

            useEffect(() => {
                const auth = localStorage.getItem('dashboard_auth');
                if (auth === 'true') {
                    setAutenticado(true);
                }
            }, []);

            if (!autenticado) {
                return <LoginScreen onLogin={() => setAutenticado(true)} />;
            }

            return <Dashboard />;
        }

        // Renderizar
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
