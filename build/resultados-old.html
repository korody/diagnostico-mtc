<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resultados - Quiz MTC</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .card {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      margin-bottom: 30px;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .header h1 {
      color: #333;
      font-size: 32px;
      margin-bottom: 10px;
    }

    .header p {
      color: #666;
      font-size: 16px;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #666;
      font-size: 18px;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      margin: 0 auto 20px;
      border: 5px solid #f3f4f6;
      border-top: 5px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .loading-dots {
      display: inline-block;
      margin-left: 5px;
    }

    .loading-dots span {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #667eea;
      margin: 0 3px;
      animation: bounce 1.4s infinite ease-in-out both;
    }

    .loading-dots span:nth-child(1) {
      animation-delay: -0.32s;
    }

    .loading-dots span:nth-child(2) {
      animation-delay: -0.16s;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes bounce {
      0%, 80%, 100% { 
        transform: scale(0);
        opacity: 0.5;
      }
      40% { 
        transform: scale(1);
        opacity: 1;
      }
    }

    .error {
      background: #fee;
      border: 2px solid #fcc;
      border-radius: 12px;
      padding: 20px;
      color: #c33;
      text-align: center;
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 30px;
      padding-bottom: 30px;
      border-bottom: 2px solid #f0f0f0;
    }

    .avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      flex-shrink: 0;
    }

    .profile-info h2 {
      font-size: 28px;
      color: #333;
      margin-bottom: 5px;
    }

    .profile-info p {
      color: #666;
      font-size: 14px;
    }

    .scores-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    @media (max-width: 768px) {
      .scores-grid {
        grid-template-columns: 1fr;
      }
    }

    .score-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      padding: 20px;
      color: white;
      text-align: center;
    }

    .score-label {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 10px;
    }

    .score-value {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .score-subtitle {
      font-size: 12px;
      opacity: 0.8;
    }

    .diagnostico-section {
      margin-top: 30px;
    }

    .diagnostico-section h3 {
      color: #333;
      font-size: 22px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .diagnostico-text {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 25px;
      color: #555;
      line-height: 1.8;
      white-space: pre-wrap;
    }

    /* Playbook Comercial */
    .playbook-section {
      margin-top: 30px;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 16px;
      padding: 30px;
      border: 3px solid #fbbf24;
    }

    .playbook-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 2px solid #f59e0b;
    }

    .playbook-header h3 {
      font-size: 24px;
      color: #92400e;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .playbook-badge {
      background: #92400e;
      color: #fef3c7;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
    }

    .playbook-profile {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      border-left: 4px solid #f59e0b;
    }

    .playbook-profile h4 {
      color: #92400e;
      font-size: 18px;
      margin-bottom: 10px;
    }

    .playbook-profile p {
      color: #78350f;
      line-height: 1.6;
      margin: 0;
    }

    .playbook-section-title {
      color: #92400e;
      font-size: 18px;
      font-weight: bold;
      margin: 25px 0 15px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .playbook-list {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
    }

    .playbook-item {
      padding: 12px 0;
      border-bottom: 1px solid #fde68a;
      color: #78350f;
      line-height: 1.6;
    }

    .playbook-item:last-child {
      border-bottom: none;
    }

    .playbook-objection {
      background: #fef3c7;
      border-left: 4px solid #f59e0b;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 12px;
    }

    .playbook-objection-title {
      color: #92400e;
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 15px;
    }

    .playbook-objection-response {
      color: #78350f;
      line-height: 1.6;
      font-size: 14px;
    }

    .playbook-script {
      background: white;
      border-radius: 12px;
      padding: 20px;
      color: #78350f;
      line-height: 1.8;
      white-space: pre-wrap;
      border: 2px solid #fbbf24;
    }

    .playbook-probability {
      background: white;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      border: 3px solid;
      margin-top: 20px;
    }

    .playbook-probability-value {
      font-size: 48px;
      font-weight: bold;
      margin: 10px 0;
    }

    .playbook-probability-label {
      color: #78350f;
      font-size: 16px;
      font-weight: 600;
    }

    /* Gr√°ficos */
    .charts-section {
      background: white;
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 20px;
    }

    @media (max-width: 1024px) {
      .charts-grid {
        grid-template-columns: 1fr;
      }
    }

    .chart-container {
      position: relative;
      height: 300px;
      min-height: 300px;
      width: 100%;
    }

    .chart-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
      text-align: center;
    }

    /* An√°lise Detalhada */
    .analise-box {
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 20px;
      border: 2px solid;
    }

    .analise-box.success {
      background: #f0fdf4;
      border-color: #86efac;
    }

    .analise-box.warning {
      background: #fef3c7;
      border-color: #fde047;
    }

    .analise-box.danger {
      background: #fee;
      border-color: #fca5a5;
    }

    .analise-box h4 {
      font-size: 18px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .analise-box ul {
      list-style: none;
      padding: 0;
      margin: 10px 0;
    }

    .analise-box li {
      padding: 8px 0;
      line-height: 1.6;
    }

    .elemento-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #f0f0f0;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      color: #333;
      font-weight: 600;
    }

    .vip-badge {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      padding: 6px 14px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      display: inline-block;
      margin-left: 10px;
    }

    .back-link {
      text-align: center;
      margin-top: 30px;
    }

    .back-link a {
      color: white;
      text-decoration: none;
      background: rgba(255,255,255,0.2);
      padding: 12px 30px;
      border-radius: 25px;
      display: inline-block;
      backdrop-filter: blur(10px);
      transition: all 0.3s;
    }

    .back-link a:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <h1 id="pageTitle">üìä Seus Resultados</h1>
        <p>Diagn√≥stico Personalizado de Medicina Chinesa</p>
      </div>

      <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <div>Carregando seus resultados<span class="loading-dots"><span></span><span></span><span></span></span></div>
      </div>

      <div id="error" style="display: none;"></div>
      <div id="content" style="display: none;"></div>
    </div>

    <div class="back-link">
      <a href="/">‚Üê Voltar ao Quiz</a>
    </div>
  </div>

  <script>
    const API_URL = window.location.hostname === 'localhost' 
      ? 'http://localhost:3001'
      : 'https://quiz-mtc.vercel.app';

    const ELEMENTO_EMOJIS = {
      'RIM': 'üåä',
      'FIGADO': 'üå≥',
      'F√çGADO': 'üå≥',
      'BACO': 'üåç',
      'BA√áO': 'üåç',
      'CORACAO': 'üî•',
      'CORA√á√ÉO': 'üî•',
      'PULMAO': 'üí®',
      'PULM√ÉO': 'üí®'
    };

    const ELEMENTO_COLORS = {
      'RIM': 'linear-gradient(135deg, #06b6d4 0%, #0891b2 100%)',
      'FIGADO': 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
      'F√çGADO': 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
      'BACO': 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
      'BA√áO': 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
      'CORACAO': 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',
      'CORA√á√ÉO': 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',
      'PULMAO': 'linear-gradient(135deg, #94a3b8 0%, #64748b 100%)',
      'PULM√ÉO': 'linear-gradient(135deg, #94a3b8 0%, #64748b 100%)'
    };

    async function carregarResultados() {
      const urlParams = new URLSearchParams(window.location.search);
      const email = urlParams.get('email');
      const leadId = urlParams.get('id');

      if (!email && !leadId) {
        mostrarErro('‚ùå Nenhum email ou ID fornecido. Use ?email=seu@email.com ou ?id=leadId');
        return;
      }

      try {
        let url = `${API_URL}/api/lead/find?`;
        if (email) url += `email=${encodeURIComponent(email)}`;
        if (leadId) url += `leadId=${leadId}`;

        const response = await fetch(url);
        const data = await response.json();

        if (!data.success) {
          mostrarErro(`‚ùå ${data.error || 'Lead n√£o encontrado'}`);
          return;
        }

        renderizarResultados(data.lead);
        
        // Carregar playbook comercial
        if (data.lead.id && data.lead.perfil_comercial) {
          carregarPlaybook(data.lead.id);
        }
      } catch (error) {
        console.error('Erro ao carregar resultados:', error);
        mostrarErro('‚ùå Erro ao carregar resultados. Verifique se o servidor est√° rodando.');
      }
    }

    function mostrarErro(mensagem) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'block';
      document.getElementById('error').className = 'error';
      document.getElementById('error').innerHTML = mensagem;
    }

    function renderizarResultados(lead) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'block';

      // Atualizar t√≠tulo com nome da pessoa
      const primeiroNome = lead.nome.split(' ')[0];
      document.getElementById('pageTitle').textContent = `üìä Resultados de ${primeiroNome}`;

      const elemento = lead.elemento_principal || 'RIM';
      const emoji = ELEMENTO_EMOJIS[elemento.toUpperCase()] || 'üßò';
      const color = ELEMENTO_COLORS[elemento.toUpperCase()] || '#667eea';

      const intensidadeScore = lead.intensidade_calculada 
        ? Math.round((lead.intensidade_calculada / 5) * 100) 
        : 0;
      const urgenciaScore = lead.urgencia_calculada 
        ? Math.round((lead.urgencia_calculada / 5) * 100) 
        : 0;

      const diagnostico = (lead.diagnostico_completo || lead.script_abertura || 'Diagn√≥stico n√£o dispon√≠vel')
        .replace(/{NOME}/g, primeiroNome);

      // Calcular scores adicionais
      const contagemElementos = lead.contagem_elementos || {};
      const valoresElementos = Object.values(contagemElementos);
      const totalElementos = valoresElementos.length > 0 ? valoresElementos.reduce((a, b) => a + b, 0) : 0;
      const elementoMax = valoresElementos.length > 0 ? Math.max(...valoresElementos) : 0;
      const equilibrioScore = totalElementos > 0 ? Math.round((1 - (elementoMax / totalElementos)) * 100) : 50;

      const autonomiaMap = { 'ALTA': 75, 'MEDIA': 50, 'MEDIA_ALTA': 65, 'BAIXA': 25 };
      const autonomiaScore = autonomiaMap[lead.autonomia_decisao] || 50;

      const investimentoScore = lead.investimento_mensal_atual ?
        Math.min(Math.round((lead.investimento_mensal_atual / 600) * 100), 100) : 0;

      // Calcular prontid√£o (combina√ß√£o de intensidade + urg√™ncia)
      const prontidaoScore = Math.round((intensidadeScore + urgenciaScore) / 2);

      const html = `
        <div class="profile-header">
          <div class="avatar" style="background: ${color};">
            ${emoji}
          </div>
          <div class="profile-info">
            <h2>${lead.nome}</h2>
            <p>
              <span class="elemento-badge">
                ${emoji} ${elemento}
              </span>
              ${lead.is_hot_lead_vip ? '<span class="vip-badge">‚≠ê VIP</span>' : ''}
            </p>
          </div>
        </div>

        <div class="scores-grid">
          <div class="score-card">
            <div class="score-label">Intensidade</div>
            <div class="score-value">${intensidadeScore}%</div>
            <div class="score-subtitle">dos sintomas</div>
          </div>
          <div class="score-card">
            <div class="score-label">Urg√™ncia</div>
            <div class="score-value">${urgenciaScore}%</div>
            <div class="score-subtitle">de tratamento</div>
          </div>
          <div class="score-card">
            <div class="score-label">Lead Score</div>
            <div class="score-value">${lead.lead_score || 0}</div>
            <div class="score-subtitle">${lead.prioridade || 'N/A'}</div>
          </div>
        </div>

        ${lead.perfil_comercial || lead.autonomia_decisao || lead.investimento_mensal_atual ? `
        <div class="scores-grid">
          ${lead.autonomia_decisao ? `
          <div class="score-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
            <div class="score-label">Autonomia</div>
            <div class="score-value">${lead.autonomia_decisao}</div>
            <div class="score-subtitle">de decis√£o</div>
          </div>
          ` : ''}
          ${lead.investimento_mensal_atual ? `
          <div class="score-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
            <div class="score-label">Investimento</div>
            <div class="score-value">R$ ${lead.investimento_mensal_atual}</div>
            <div class="score-subtitle">mensal atual</div>
          </div>
          ` : ''}
          ${lead.confianca_arquetipo ? `
          <div class="score-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
            <div class="score-label">Confian√ßa</div>
            <div class="score-value">${Math.round(lead.confianca_arquetipo * 100)}%</div>
            <div class="score-subtitle">no perfil</div>
          </div>
          ` : ''}
        </div>
        ` : ''}

        ${renderGraficos(lead, intensidadeScore, urgenciaScore, prontidaoScore, equilibrioScore, autonomiaScore, investimentoScore)}

        ${renderAnaliseDetalhada(intensidadeScore, urgenciaScore, prontidaoScore, autonomiaScore)}

        <div class="diagnostico-section">
          <h3>ÔøΩ An√°lise Comercial</h3>
          <div class="diagnostico-text">
            ${lead.perfil_comercial ? `<p><strong>üéØ Perfil Comercial:</strong> ${lead.perfil_comercial.replace(/_/g, ' ')}</p>` : ''}
            ${lead.objecao_principal ? `<p><strong>‚ö†Ô∏è Obje√ß√£o Principal:</strong> ${lead.objecao_principal}</p>` : ''}
            ${lead.autonomia_decisao ? `<p><strong>üë§ Autonomia de Decis√£o:</strong> ${lead.autonomia_decisao}</p>` : ''}
            ${lead.investimento_mensal_atual ? `<p><strong>üí∞ Investimento Mensal Atual:</strong> R$ ${lead.investimento_mensal_atual}</p>` : ''}
            ${lead.estado ? `<p><strong>üìç Estado:</strong> ${lead.estado}</p>` : ''}
            ${lead.custo_mensal_problema ? `<p><strong>üí∏ Custo Mensal do Problema:</strong> R$ ${lead.custo_mensal_problema}</p>` : ''}
          </div>
        </div>

        <div class="diagnostico-section">
          <h3>üìã Seu Diagn√≥stico Personalizado</h3>
          <div class="diagnostico-text">${diagnostico}</div>
        </div>
      `;

      document.getElementById('content').innerHTML = html;

      // Renderizar gr√°ficos ap√≥s inserir HTML
      setTimeout(() => {
        renderCharts(lead, intensidadeScore, urgenciaScore, prontidaoScore, equilibrioScore, autonomiaScore, investimentoScore);
      }, 100);
    }

    function renderGraficos(lead, intensidadeScore, urgenciaScore, prontidaoScore, equilibrioScore, autonomiaScore, investimentoScore) {
      return `
        <div class="charts-section">
          <h2 style="font-size: 24px; font-weight: bold; color: #333; margin-bottom: 20px;">üìä Compara√ß√£o por √Åreas</h2>
          <div class="charts-grid">
            <div>
              <div class="chart-title">An√°lise Comparativa</div>
              <div class="chart-container">
                <canvas id="barChart" width="600" height="400"></canvas>
              </div>
            </div>
            <div>
              <div class="chart-title">Vis√£o 360¬∞ - Elementos MTC</div>
              <div class="chart-container">
                <canvas id="radarChart" width="600" height="400"></canvas>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderAnaliseDetalhada(intensidadeScore, urgenciaScore, prontidaoScore, autonomiaScore) {
      const pontosFortes = [];
      const atencao = [];
      const prioridade = [];

      if (prontidaoScore >= 70) pontosFortes.push('‚Ä¢ <strong>Alta prontid√£o</strong> para mudan√ßa - voc√™ est√° motivada e pronta para agir');
      else if (prontidaoScore >= 40) atencao.push('‚Ä¢ <strong>Prontid√£o moderada</strong> - h√° interesse mas pode precisar de mais motiva√ß√£o');
      else prioridade.push('‚Ä¢ <strong>Baixa prontid√£o</strong> - precisa entender melhor os benef√≠cios antes de agir');

      if (intensidadeScore >= 70) pontosFortes.push('‚Ä¢ <strong>Consci√™ncia elevada</strong> sobre os sintomas - sabe exatamente o que precisa resolver');
      else if (intensidadeScore >= 40) atencao.push('‚Ä¢ <strong>Sintomas moderados</strong> - desconforto presente mas ainda gerenci√°vel');
      else prioridade.push('‚Ä¢ <strong>Sintomas leves</strong> - preven√ß√£o √© a melhor estrat√©gia');

      if (urgenciaScore >= 70) pontosFortes.push('‚Ä¢ <strong>Senso de urg√™ncia</strong> saud√°vel - entende a import√¢ncia de agir agora');
      else if (urgenciaScore >= 40) atencao.push('‚Ä¢ <strong>Urg√™ncia moderada</strong> - percebe que precisa agir mas n√£o v√™ como prioridade m√°xima');
      else prioridade.push('‚Ä¢ <strong>Baixa urg√™ncia</strong> - ainda n√£o percebe a necessidade imediata de mudan√ßa');

      if (autonomiaScore >= 70) pontosFortes.push('‚Ä¢ <strong>Autonomia de decis√£o</strong> - pode tomar decis√µes sobre sua sa√∫de');
      else atencao.push('‚Ä¢ <strong>Decis√£o compartilhada</strong> - pode precisar consultar outras pessoas');

      let html = '<div class="diagnostico-section"><h3 style="font-size: 22px; font-weight: bold; color: #333; margin-bottom: 20px;">üß† An√°lise Detalhada e Recomenda√ß√µes</h3>';

      if (pontosFortes.length > 0) {
        html += `
          <div class="analise-box success">
            <h4 style="color: #16a34a;">‚úÖ Pontos Fortes (70%+)</h4>
            <ul style="color: #15803d;">${pontosFortes.join('')}</ul>
            <p style="margin-top: 15px; color: #15803d; font-weight: 600;">
              üí° Recomenda√ß√£o: Aproveite esse momento de clareza e motiva√ß√£o. Voc√™ est√° no ponto ideal para come√ßar!
            </p>
          </div>
        `;
      }

      if (atencao.length > 0) {
        html += `
          <div class="analise-box warning">
            <h4 style="color: #92400e;">‚ö†Ô∏è √Åreas de Aten√ß√£o (40-69%)</h4>
            <ul style="color: #78350f;">${atencao.join('')}</ul>
            <p style="margin-top: 15px; color: #78350f; font-weight: 600;">
              üí° Recomenda√ß√£o: Voc√™ est√° no caminho certo, mas pode se beneficiar de mais informa√ß√µes e suporte.
            </p>
          </div>
        `;
      }

      if (prioridade.length > 0) {
        html += `
          <div class="analise-box danger">
            <h4 style="color: #dc2626;">üéØ Prioridades Cr√≠ticas (Abaixo de 40%)</h4>
            <ul style="color: #991b1b;">${prioridade.join('')}</ul>
            <p style="margin-top: 15px; color: #991b1b; font-weight: 600;">
              üí° Recomenda√ß√£o: Foque primeiro em entender os benef√≠cios e construir motiva√ß√£o. A educa√ß√£o √© o primeiro passo.
            </p>
          </div>
        `;
      }

      html += '</div>';
      return html;
    }

    function renderCharts(lead, intensidadeScore, urgenciaScore, prontidaoScore, equilibrioScore, autonomiaScore, investimentoScore) {
      console.log('üé® renderCharts chamado');
      console.log('Scores:', { prontidaoScore, intensidadeScore, urgenciaScore, equilibrioScore, autonomiaScore, investimentoScore });

      // Verificar se Chart.js est√° dispon√≠vel
      if (typeof Chart === 'undefined') {
        console.error('‚ùå Chart.js n√£o est√° carregado');
        return;
      }
      console.log('‚úÖ Chart.js carregado, vers√£o:', Chart.version);

      // Bar Chart
      const barCtx = document.getElementById('barChart');
      console.log('barChart element:', barCtx);
      if (barCtx) {
        new Chart(barCtx, {
          type: 'bar',
          data: {
            labels: ['Prontid√£o', 'Intensidade', 'Urg√™ncia', 'Equil√≠brio', 'Autonomia', 'Investimento'],
            datasets: [{
              label: 'Score (%)',
              data: [prontidaoScore, intensidadeScore, urgenciaScore, equilibrioScore, autonomiaScore, investimentoScore],
              backgroundColor: [
                'rgba(102, 126, 234, 0.8)',
                'rgba(239, 68, 68, 0.8)',
                'rgba(251, 146, 60, 0.8)',
                'rgba(34, 197, 94, 0.8)',
                'rgba(168, 85, 247, 0.8)',
                'rgba(59, 130, 246, 0.8)'
              ],
              borderColor: [
                'rgb(102, 126, 234)',
                'rgb(239, 68, 68)',
                'rgb(251, 146, 60)',
                'rgb(34, 197, 94)',
                'rgb(168, 85, 247)',
                'rgb(59, 130, 246)'
              ],
              borderWidth: 2,
              borderRadius: 8
            }]
          },
          options: {
            responsive: false,
            animation: {
              duration: 0
            },
            plugins: {
              legend: {
                display: true
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                grid: {
                  color: 'rgba(0, 0, 0, 0.1)'
                }
              },
              x: {
                grid: {
                  display: false
                }
              }
            }
          }
        });
        console.log('‚úÖ Gr√°fico de barras criado');
      } else {
        console.error('‚ùå Elemento barChart n√£o encontrado');
      }

      // Radar Chart
      const radarCtx = document.getElementById('radarChart');
      console.log('radarChart element:', radarCtx);
      console.log('contagem_elementos:', lead.contagem_elementos);
      if (radarCtx && lead.contagem_elementos) {
        new Chart(radarCtx, {
          type: 'radar',
          data: {
            labels: ['Rim', 'F√≠gado', 'Ba√ßo', 'Cora√ß√£o', 'Pulm√£o'],
            datasets: [{
              label: 'Elementos MTC',
              data: [
                lead.contagem_elementos.RIM || 0,
                lead.contagem_elementos.F√çGADO || 0,
                lead.contagem_elementos.BA√áO || 0,
                lead.contagem_elementos.CORA√á√ÉO || 0,
                lead.contagem_elementos.PULM√ÉO || 0
              ],
              backgroundColor: 'rgba(102, 126, 234, 0.4)',
              borderColor: 'rgb(102, 126, 234)',
              borderWidth: 3,
              pointBackgroundColor: 'rgb(102, 126, 234)',
              pointBorderColor: '#fff',
              pointHoverBackgroundColor: '#fff',
              pointHoverBorderColor: 'rgb(102, 126, 234)',
              pointRadius: 5,
              pointHoverRadius: 7
            }]
          },
          options: {
            responsive: false,
            animation: {
              duration: 0
            },
            plugins: {
              legend: {
                display: true
              }
            },
            scales: {
              r: {
                beginAtZero: true,
                max: 10,
                ticks: {
                  stepSize: 2,
                  backdropColor: 'transparent'
                },
                grid: {
                  color: 'rgba(0, 0, 0, 0.1)'
                },
                angleLines: {
                  color: 'rgba(0, 0, 0, 0.1)'
                }
              }
            }
          }
        });
        console.log('‚úÖ Gr√°fico radar criado');
      } else {
        if (!radarCtx) console.error('‚ùå Elemento radarChart n√£o encontrado');
        if (!lead.contagem_elementos) console.warn('‚ö†Ô∏è contagem_elementos n√£o dispon√≠vel');
      }
    }

    async function carregarPlaybook(leadId) {
      try {
        const response = await fetch(`${API_URL}/api/lead/playbook?leadId=${leadId}`);
        const data = await response.json();

        if (!data.success) {
          // Se n√£o houver playbook, n√£o mostrar erro, apenas n√£o renderizar
          return;
        }

        renderizarPlaybook(data.lead, data.relatorio);
      } catch (error) {
        console.error('Erro ao carregar playbook:', error);
        // Silencioso - n√£o mostrar erro se playbook n√£o estiver dispon√≠vel
      }
    }

    function renderizarPlaybook(lead, relatorio) {
      const playbookHTML = `
        <div class="playbook-section">
          <div class="playbook-header">
            <h3>üíº Playbook Comercial - Estrat√©gia de Fechamento</h3>
            <span class="playbook-badge">${lead.perfil_comercial.replace(/_/g, ' ')}</span>
          </div>

          <div class="playbook-profile">
            <h4>üéØ Perfil: ${lead.perfil_comercial.replace(/_/g, ' ')}</h4>
            <p><strong>Caracter√≠sticas:</strong> ${relatorio.caracteristicas}</p>
          </div>

          <div class="playbook-section-title">‚ö†Ô∏è Obje√ß√µes Prov√°veis</div>
          <div class="playbook-list">
            ${relatorio.objecoes.map(obj => `
              <div class="playbook-objection">
                <div class="playbook-objection-title">${obj.objecao}</div>
                <div class="playbook-objection-response">üí¨ ${obj.resposta}</div>
              </div>
            `).join('')}
          </div>

          <div class="playbook-section-title">üî• Gatilhos de Urg√™ncia</div>
          <div class="playbook-list">
            ${relatorio.gatilhos_urgencia.map(gatilho => `
              <div class="playbook-item">${gatilho}</div>
            `).join('')}
          </div>

          <div class="playbook-section-title">‚ùì Perguntas de Qualifica√ß√£o</div>
          <div class="playbook-list">
            ${relatorio.perguntas_qualificacao.map((pergunta, index) => `
              <div class="playbook-item"><strong>${index + 1}.</strong> ${pergunta}</div>
            `).join('')}
          </div>

          <div class="playbook-section-title">üé¨ Script de Fechamento</div>
          <div class="playbook-script">${relatorio.script_fechamento}</div>

          ${relatorio.probabilidade_fechamento !== undefined ? `
            <div class="playbook-probability" style="border-color: ${
              relatorio.probabilidade_fechamento >= 70 ? '#16a34a' : 
              relatorio.probabilidade_fechamento >= 40 ? '#f59e0b' : '#dc2626'
            };">
              <div class="playbook-probability-label">Probabilidade de Fechamento</div>
              <div class="playbook-probability-value" style="color: ${
                relatorio.probabilidade_fechamento >= 70 ? '#16a34a' : 
                relatorio.probabilidade_fechamento >= 40 ? '#f59e0b' : '#dc2626'
              };">${relatorio.probabilidade_fechamento}%</div>
            </div>
          ` : ''}
        </div>
      `;

      // Inserir playbook ap√≥s o conte√∫do principal
      document.getElementById('content').innerHTML += playbookHTML;
    }

    // Carregar ao iniciar
    carregarResultados();
  </script>
</body>
</html>
